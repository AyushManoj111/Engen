{% extends 'gerente/base.html' %}

{% block title %}Nova Requisição de Saldo - ENGEN{% endblock %}

{% block content %}

<div class="adicionar-content">
    <div class="content-header">
        <h2></h2>
        <a href="{% url 'requisicoes_saldo' %}" class="btn-secondary">
            ← Voltar
        </a>
    </div>

    <div class="form-container">
        <div class="form-card">
            <form method="post" action="{% url 'adicionar_requisicao_saldo' %}">
                {% csrf_token %}

                <div class="form-body">
                    <div class="form-group">
                        <label for="cliente">Cliente <span class="required">*</span></label>
                        <select class="form-control" id="cliente" name="cliente" required>
                            <option value="">Selecione um cliente</option>
                            {% for cliente in clientes %}
                            <option value="{{ cliente.id }}">{{ cliente.nome }}</option>
                            {% endfor %}
                        </select>
                        <small class="form-text">
                            <a href="{% url 'adicionar_cliente' %}" class="btn-link">+ Adicionar novo cliente</a>
                        </small>
                    </div>

                    <div class="form-group">
                        <label for="valor_total">Valor Total (MT) <span class="required">*</span></label>
                        <input type="number" class="form-control" id="valor_total" name="valor_total" step="0.01"
                            min="0" placeholder="0.00" required>
                        <small class="form-text">Valor total do saldo a ser creditado</small>
                    </div>

                    <div class="form-group">
                        <label for="forma_pagamento">Forma de Pagamento <span class="required">*</span></label>
                        <select class="form-control" id="forma_pagamento" name="forma_pagamento" required
                            onchange="toggleBancoField()">
                            <option value="">Selecione a forma de pagamento</option>
                            <option value="transferencia">Transferência Bancária</option>
                            <option value="cash" selected>Dinheiro (Cash)</option>
                            <option value="pos">POS (Cartão)</option>
                        </select>
                    </div>

                    <div class="form-group" id="banco_group" style="display: none;">
                        <label for="banco">Nome do Banco <span class="required">*</span></label>
                        <textarea class="form-control" id="banco" name="banco" rows="2"
                            placeholder="Digite o nome do banco"></textarea>
                        <small class="form-text">Obrigatório para transferência bancária</small>
                    </div>
                </div>

                <div class="form-footer">
                    <a href="{% url 'requisicoes_saldo' %}" class="btn-secondary">Cancelar</a>
                    <button type="submit" class="btn-submit">Criar Requisição de Saldo</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Recibo -->
    {% if mostrar_recibo %}
    <div class="modal-overlay" id="reciboModal">
        <div class="modal-container recibo-modal">
            <div class="modal-header">
                <h3>Recibo de Requisição de Saldo</h3>
                <button type="button" class="modal-close" onclick="fecharRecibo()">×</button>
            </div>

            <div class="modal-body" id="reciboContent">
                <div class="recibo-header">
                    <div class="empresa-info">
                        <h2>{{ requisicao.empresa.nome|default:"ENGEN" }}</h2>
                        <p>Sistema de Gestão de Requisições de Saldo</p>
                    </div>
                    <div class="recibo-numero">
                        <p><strong>Recibo Nº:</strong> {{ requisicao.id|stringformat:"06d" }}</p>
                        <p><strong>Código:</strong> {{ requisicao.codigo }}</p>
                        <p><strong>Data:</strong> {{ requisicao.data_criacao|date:"d/m/Y H:i" }}</p>
                    </div>
                </div>

                <div class="recibo-divider"></div>

                <div class="recibo-details">
                    <div class="detail-row">
                        <span class="detail-label">Cliente:</span>
                        <span class="detail-value">{{ requisicao.cliente.nome }}</span>
                    </div>

                    <div class="detail-row">
                        <span class="detail-label">Valor Total:</span>
                        <span class="detail-value valor-destaque">{{ requisicao.valor_total|floatformat:2 }} MT</span>
                    </div>

                    <div class="detail-row">
                        <span class="detail-label">Saldo Restante:</span>
                        <span class="detail-value valor-saldo">{{ requisicao.saldo_restante|floatformat:2 }} MT</span>
                    </div>

                    <div class="detail-row">
                        <span class="detail-label">Forma de Pagamento:</span>
                        <span class="detail-value">
                            {% if requisicao.forma_pagamento == 'transferencia' %}
                            <i class="fas fa-university"></i> Transferência Bancária
                            {% elif requisicao.forma_pagamento == 'cash' %}
                            <i class="fas fa-money-bill-wave"></i> Dinheiro (Cash)
                            {% elif requisicao.forma_pagamento == 'pos' %}
                            <i class="fas fa-credit-card"></i> POS (Cartão)
                            {% else %}
                            {{ requisicao.get_forma_pagamento_display }}
                            {% endif %}
                        </span>
                    </div>

                    {% if requisicao.banco %}
                    <div class="detail-row">
                        <span class="detail-label">Banco:</span>
                        <span class="detail-value">{{ requisicao.banco }}</span>
                    </div>
                    {% endif %}

                    <div class="detail-row">
                        <span class="detail-label">Status:</span>
                        <span class="detail-value status-ativa">
                            {% if requisicao.ativa %}Ativa{% else %}Inativa{% endif %}
                        </span>
                    </div>

                    <div class="detail-row">
                        <span class="detail-label">Tipo:</span>
                        <span class="detail-value">
                            <i class="fas fa-wallet"></i> Requisição de Saldo
                        </span>
                    </div>
                </div>

                <div class="recibo-divider"></div>

                <div class="recibo-info-box">
                    <h4><i class="fas fa-info-circle"></i> Informações Importantes</h4>
                    <ul>
                        <li>Este saldo poderá ser utilizado para movimentações futuras</li>
                        <li>O saldo restante será atualizado a cada movimentação</li>
                        <li>Guarde este recibo como comprovante de pagamento</li>
                        <li>Em caso de dúvidas, entre em contato conosco</li>
                    </ul>
                </div>

                <div class="recibo-footer">
                    <p class="recibo-assinatura">
                        _________________________________<br>
                        Assinatura do Responsável
                    </p>
                    <p class="recibo-data-impressao">
                        Impresso em: {% now "d/m/Y H:i:s" %}
                    </p>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="fecharRecibo()">Fechar</button>
                <button type="button" class="btn-primary" onclick="imprimirRecibo()">
                    <i class="fas fa-print"></i> Imprimir PDF
                </button>
            </div>
        </div>
    </div>

    <!-- Hidden data for JavaScript -->
    <script type="application/json" id="requisicao-data">
    {
        "requisicaoId": "{{ requisicao.id|default:'' }}",
        "hasRequisicao": {% if requisicao %}true{% else %}false{% endif %},
        "reciboUrl": "{% if requisicao %}{% url 'gerar_recibo_saldo_pdf' requisicao.id %}{% endif %}",
        "requisicoesUrl": "{% url 'requisicoes_saldo' %}"
    }
    </script>
    {% endif %}
</div>

<script>
    function toggleBancoField() {
        const formaPagamento = document.getElementById('forma_pagamento').value;
        const bancoGroup = document.getElementById('banco_group');
        const bancoField = document.getElementById('banco');

        if (formaPagamento === 'transferencia') {
            bancoGroup.style.display = 'block';
            bancoField.required = true;
        } else {
            bancoGroup.style.display = 'none';
            bancoField.required = false;
            bancoField.value = '';
        }
    }

    // Get configuration data from JSON script tag
    function getConfigData() {
        const configElement = document.getElementById('requisicao-data');
        if (configElement) {
            try {
                return JSON.parse(configElement.textContent);
            } catch (e) {
                console.error('Error parsing config data:', e);
                return {};
            }
        }
        return {};
    }

    function fecharRecibo() {
        const modal = document.getElementById('reciboModal');
        if (modal) {
            modal.style.display = 'none';
            // Redirecionar para lista de requisições após fechar
            const config = getConfigData();
            if (config.requisicoesUrl) {
                window.location.href = config.requisicoesUrl;
            } else {
                // Fallback URL
                window.location.href = '/requisicoes/';
            }
        }
    }

    function imprimirRecibo() {
        const config = getConfigData();

        // Verificar se temos requisição para gerar PDF
        if (config.hasRequisicao && config.reciboUrl) {
            // Abrir PDF em nova aba
            window.open(config.reciboUrl, '_blank');
        } else {
            // Fallback: imprimir a página atual
            window.print();
        }
    }

    function baixarReciboPDF() {
        const config = getConfigData();

        if (config.hasRequisicao && config.reciboUrl) {
            window.location.href = config.reciboUrl;
        } else {
            alert('Erro: Requisição não encontrada');
        }
    }

    // Fechar modal com ESC
    document.addEventListener('keydown', function (event) {
        if (event.key === 'Escape') {
            fecharRecibo();
        }
    });

    // Fechar modal clicando fora
    document.addEventListener('click', function (event) {
        const modal = document.getElementById('reciboModal');
        if (modal && event.target === modal) {
            fecharRecibo();
        }
    });

    // Initialize modal if present
    document.addEventListener('DOMContentLoaded', function () {
        const modal = document.getElementById('reciboModal');
        if (modal) {
            // Modal is already visible due to server-side rendering
            console.log('Recibo modal initialized');
        }
    });
</script>

{% endblock %}