{% extends 'gerente/base.html' %}

{% block title %}Preview do Fecho - ENGEN{% endblock %}

{% block extra_css %}

{% endblock %}

{% block content %}
<div class="content-header">
    <h2>Preview do Fecho</h2>
    <small class="text-muted">Revis√£o dos dados antes do fechamento</small>
</div>

{% if total_registros > 0 %}
<div class="preview-header">
    <h3>üîí Dados que ser√£o fechados</h3>
    <p>{{ total_registros|default:0 }} registro{{ total_registros|pluralize }} ser√£o inclu√≠dos no pr√≥ximo fecho</p>
    <small>Data atual: {% now "d/m/Y H:i" %}</small>
</div>

<div class="warning-box">
    <h5>‚ö†Ô∏è ATEN√á√ÉO - A√á√ÉO IRREVERS√çVEL</h5>
    <p>Ap√≥s confirmar o fecho, os dados listados abaixo <strong>N√ÉO PODER√ÉO</strong> mais ser editados ou exclu√≠dos. Esta a√ß√£o √© <strong>PERMANENTE E IRREVERS√çVEL</strong>!</p>
    <small>Certifique-se de que todos os dados est√£o corretos antes de prosseguir.</small>
</div>

<!-- Resumo Financeiro -->
<div class="summary-card">
    <h5 style="margin-bottom: 20px; color: #495057;">üìä Resumo Financeiro</h5>
    <div class="summary-grid">
        <div class="summary-item entradas">
            <div class="value">{{ total_entradas|floatformat:2 }} MT</div>
            <div class="label">Total Entradas</div>
        </div>
        <div class="summary-item saidas">
            <div class="value">{{ total_saidas|floatformat:2 }} MT</div>
            <div class="label">Total Sa√≠das</div>
        </div>
        <div class="summary-item saldo">
            <div class="value">{{ total_entradas|sub:total_saidas|floatformat:2 }} MT</div>
            <div class="label">Saldo L√≠quido</div>
        </div>
    </div>
</div>

<div class="preview-stats">
    <div class="stat-preview receitas">
        <h4>Requisi√ß√µes de Senhas</h4>
        <div class="number">{{ count_req_senhas }}</div>
        <div class="label">{{ total_valor_senhas|floatformat:2 }} MT</div>
    </div>
    
    <div class="stat-preview receitas">
        <h4>Requisi√ß√µes de Saldo</h4>
        <div class="number">{{ count_req_saldo }}</div>
        <div class="label">{{ total_valor_saldo|floatformat:2 }} MT</div>
    </div>
    
    <div class="stat-preview despesas">
        <h4>Movimentos (D√©bitos)</h4>
        <div class="number">{{ count_movimentos }}</div>
        <div class="label">{{ total_debitos_saldo|floatformat:2 }} MT</div>
    </div>
    
    <div class="stat-preview">
        <h4>Senhas Usadas</h4>
        <div class="number">{{ count_senhas_usadas }}</div>
        <div class="label">Consumidas</div>
    </div>
</div>

<!-- Requisi√ß√µes de Senhas (RECEITAS) -->
{% if requisicoes_senhas_abertas %}
<div class="preview-table receitas">
    <h5>üìã Requisi√ß√µes de Senhas ({{ count_req_senhas }})</h5>
    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>Cliente</th>
                <th>Valor</th>
                <th>Senhas</th>
                <th>Restantes</th>
                <th>Data</th>
            </tr>
        </thead>
        <tbody>
            {% for req in requisicoes_senhas_abertas %}
            <tr>
                <td>#{{ req.id }}</td>
                <td>{{ req.cliente.nome|default:"N/A" }}</td>
                <td>{{ req.valor|floatformat:2 }} MT</td>
                <td>{{ req.senhas|default:"-" }}</td>
                <td>{{ req.senhas_restantes|default:"-" }}</td>
                <td>{{ req.data_criacao|date:"d/m/Y" }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

<!-- Requisi√ß√µes de Saldo (RECEITAS) -->
{% if requisicoes_saldo_abertas %}
<div class="preview-table receitas">
    <h5>üí∞ Requisi√ß√µes de Saldo ({{ count_req_saldo }})</h5>
    <table>
        <thead>
            <tr>
                <th>C√≥digo</th>
                <th>Cliente</th>
                <th>Valor Total</th>
                <th>Saldo Restante</th>
                <th>Data</th>
            </tr>
        </thead>
        <tbody>
            {% for req in requisicoes_saldo_abertas %}
            <tr>
                <td>{{ req.codigo|default:"-" }}</td>
                <td>{{ req.cliente.nome|default:"N/A" }}</td>
                <td>{{ req.valor_total|floatformat:2 }} MT</td>
                <td>{{ req.saldo_restante|floatformat:2 }} MT</td>
                <td>{{ req.data_criacao|date:"d/m/Y" }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

<!-- Movimentos (D√âBITOS) -->
{% if movimentos_abertos %}
<div class="preview-table despesas">
    <h5>üîÑ Movimentos - D√©bitos ({{ count_movimentos }})</h5>
    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>Cliente</th>
                <th>Descri√ß√£o</th>
                <th>Valor</th>
                <th>Funcion√°rio</th>
                <th>Data</th>
            </tr>
        </thead>
        <tbody>
            {% for mov in movimentos_abertos %}
            <tr>
                <td>#{{ mov.id }}</td>
                <td>{{ mov.requisicao_saldo.cliente.nome|default:"N/A" }}</td>
                <td>{{ mov.descricao|default:"Movimento"|truncatechars:50 }}</td>
                <td>{{ mov.valor|floatformat:2 }} MT</td>
                <td>{{ mov.funcionario.nome|default:"N/A" }}</td>
                <td>{{ mov.data_criacao|date:"d/m/Y H:i" }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

<!-- Senhas Usadas -->
{% if senhas_usadas_abertas %}
<div class="preview-table despesas">
    <h5>üîê Senhas Usadas ({{ count_senhas_usadas }})</h5>
    <table>
        <thead>
            <tr>
                <th>C√≥digo</th>
                <th>Cliente</th>
                <th>Requisi√ß√£o</th>
                <th>Data Uso</th>
                <th>Funcion√°rio</th>
            </tr>
        </thead>
        <tbody>
            {% for senha in senhas_usadas_abertas %}
            <tr>
                <td>{{ senha.codigo }}</td>
                <td>{{ senha.requisicao.cliente.nome|default:"N/A" }}</td>
                <td>#{{ senha.requisicao.id }}</td>
                <td>{{ senha.data_uso|date:"d/m/Y H:i"|default:"N/A" }}</td>
                <td>{{ senha.funcionario_uso.nome|default:"N/A" }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

<div class="info-box">
    <h5>‚ÑπÔ∏è Informa√ß√£o Importante</h5>
    <p>Ap√≥s o fecho, voc√™ ainda poder√° <strong>visualizar</strong> todos estes dados nos relat√≥rios, mas n√£o poder√° mais <strong>modific√°-los</strong>. 
    Apenas novos registros criados ap√≥s este fecho poder√£o ser editados at√© o pr√≥ximo fecho.</p>
    <small><strong>Dica:</strong> Recomendamos fazer um backup dos dados antes de prosseguir.</small>
</div>

<div class="loading-spinner" id="loadingSpinner">
    <div class="spinner"></div>
    <p>Processando fecho, aguarde...</p>
</div>

<div class="action-buttons">
    <a href="{% url 'fazer_fecho' %}" class="btn-confirmar" id="btnConfirmar">
        üîí Confirmar Fecho
    </a>
    <a href="{% url 'fecho' %}" class="btn-cancelar">
        ‚ùå Cancelar
    </a>
</div>

{% else %}
<div class="empty-message">
    <div class="preview-card">
        <h4>‚úÖ N√£o h√° dados pendentes para fecho</h4>
        <p>Todos os dados j√° foram fechados ou n√£o existem registros para processar.</p>
        <br>
        <a href="{% url 'fecho' %}" class="btn-cancelar">‚Üê Voltar ao Fecho</a>
    </div>
</div>
{% endif %}

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Pass Django variables to JavaScript safely
    const totalRegistros = parseInt('{{ total_registros|default:0 }}') || 0;
    
    const btnConfirmar = document.getElementById('btnConfirmar');
    const loadingSpinner = document.getElementById('loadingSpinner');
    
    if (btnConfirmar) {
        btnConfirmar.addEventListener('click', function(e) {
            e.preventDefault();
            
            let confirmMessage = `Voc√™ est√° prestes a fechar ${totalRegistros} registro(s)!\n\n`;
            confirmMessage += `Esta a√ß√£o √© IRREVERS√çVEL e impedir√° futuras edi√ß√µes.\n\n`;
            confirmMessage += `Tem certeza que deseja continuar?`;
            
            const primeiraConfirmacao = confirm(confirmMessage);
            
            if (primeiraConfirmacao) {
                let segundaMessage = 'CONFIRMA√á√ÉO FINAL:\n\n';
                segundaMessage += 'Esta √© sua √∫ltima chance de cancelar.\n';
                segundaMessage += 'Clique OK para realizar o fecho definitivamente.';
                
                const segundaConfirmacao = confirm(segundaMessage);
                
                if (segundaConfirmacao) {
                    // Mostrar loading
                    if (loadingSpinner) {
                        loadingSpinner.style.display = 'block';
                    }
                    btnConfirmar.style.display = 'none';
                    
                    // Desabilitar bot√£o cancelar
                    const btnCancelar = document.querySelector('.btn-cancelar');
                    if (btnCancelar) {
                        btnCancelar.style.opacity = '0.5';
                        btnCancelar.style.pointerEvents = 'none';
                    }
                    
                    // Redirecionar ap√≥s pequeno delay para mostrar loading
                    setTimeout(() => {
                        window.location.href = this.href;
                    }, 500);
                }
            }
        });
    }
    
    // Prevenir m√∫ltiplos cliques
    let isProcessing = false;
    if (btnConfirmar) {
        const handleClick = function(e) {
            if (isProcessing) {
                e.preventDefault();
                return false;
            }
            isProcessing = true;
            setTimeout(() => { isProcessing = false; }, 3000);
        };
        
        btnConfirmar.addEventListener('click', handleClick);
    }
    
    // Aviso antes de sair da p√°gina
    let shouldWarn = true;
    window.addEventListener('beforeunload', function(e) {
        if (shouldWarn && totalRegistros > 0) {
            const message = 'Voc√™ tem dados pendentes para fecho. Tem certeza que deseja sair?';
            e.preventDefault();
            e.returnValue = message;
            return message;
        }
    });
    
    // Desabilitar aviso quando clicando nos bot√µes
    document.querySelectorAll('.btn-confirmar, .btn-cancelar').forEach(btn => {
        btn.addEventListener('click', () => {
            shouldWarn = false;
        });
    });
    
    // Adicionar bot√£o de impress√£o se necess√°rio
    if (totalRegistros > 0) {
        const actionButtons = document.querySelector('.action-buttons');
        if (actionButtons) {
            const printBtn = document.createElement('button');
            printBtn.className = 'btn-cancelar';
            printBtn.innerHTML = 'üñ®Ô∏è Imprimir Preview';
            printBtn.onclick = function() { window.print(); };
            printBtn.style.marginLeft = '10px';
            actionButtons.appendChild(printBtn);
        }
    }
});
</script>
{% endblock %}