{% extends 'gerente/base.html' %}

{% block title %}Editar Requisi√ß√£o - ENGEN{% endblock %}

{% block content %}
<div class="content-header">
    <h2>Editar Requisi√ß√£o</h2>
    <a href="{% url 'requisicoes' %}" class="btn-secondary">
        ‚Üê Voltar
    </a>
</div>

<div class="form-container">
    <div class="form-card">
        <div class="form-header">
            <h3>Requisi√ß√£o #{{ requisicao.id }} - {{ requisicao.cliente.nome }}</h3>
        </div>

        <form method="post" action="{% url 'editar_requisicao' requisicao.id %}">
            {% csrf_token %}

            <div class="form-body">
                <div class="form-group">
                    <label for="cliente">Cliente <span class="required">*</span></label>
                    <select class="form-control" id="cliente" name="cliente" required>
                        <option value="">Selecione um cliente</option>
                        {% for cliente in clientes %}
                        <option value="{{ cliente.id }}" {% if cliente.id == requisicao.cliente.id %}selected{% endif %}>
                            {{ cliente.nome }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group">
                    <label for="valor">Valor (MT) <span class="required">*</span></label>
                    <input type="number" class="form-control" id="valor" name="valor" step="0.01" min="0"
                        value="{{ requisicao.valor }}" required>
                </div>

                <div class="form-group">
                    <label for="quantidade_senhas">Quantidade de Senhas <span class="required">*</span></label>
                    <input type="number" class="form-control" id="quantidade_senhas" name="quantidade_senhas" min="1"
                        value="{{ requisicao.senhas }}" required>
                    <small class="form-text">Quantidade total de senhas para esta requisi√ß√£o</small>
                </div>

                <div class="form-group">
                    <label for="senhas_restantes">Senhas Restantes</label>
                    <input type="number" class="form-control" id="senhas_restantes" name="senhas_restantes" min="0"
                        value="{{ requisicao.senhas_restantes }}">
                    <small class="form-text">Quantidade de senhas ainda dispon√≠veis</small>
                </div>

                <div class="form-group">
                    <label for="forma_pagamento">Forma de Pagamento <span class="required">*</span></label>
                    <select class="form-control" id="forma_pagamento" name="forma_pagamento" required>
                        <option value="">Selecione a forma de pagamento</option>
                        <option value="transferencia" {% if requisicao.forma_pagamento == 'transferencia' %}selected{% endif %}>
                            Transfer√™ncia Banc√°ria
                        </option>
                        <option value="cash" {% if requisicao.forma_pagamento == 'cash' %}selected{% endif %}>
                            Dinheiro (Cash)
                        </option>
                        <option value="pos" {% if requisicao.forma_pagamento == 'pos' %}selected{% endif %}>
                            POS (Cart√£o)
                        </option>
                    </select>
                </div>

                <div class="form-group" id="banco-group" style="display: none;">
                    <label for="banco">Nome do Banco <span class="required">*</span></label>
                    <input type="text" class="form-control" id="banco" name="banco" placeholder="Digite o nome do banco"
                        value="{{ requisicao.banco|default:'' }}">
                    <small class="form-text">Obrigat√≥rio para transfer√™ncia banc√°ria</small>
                </div>

                <div class="form-group">
                    <label for="observacoes">Observa√ß√µes</label>
                    <textarea class="form-control" id="observacoes" name="observacoes" rows="3"
                        placeholder="Observa√ß√µes sobre a requisi√ß√£o">{{ requisicao.observacoes|default:'' }}</textarea>
                </div>
            </div>

            <div class="form-footer">
                <a href="{% url 'requisicoes' %}" class="btn-secondary">Cancelar</a>
                <button type="submit" class="btn-submit">Atualizar Requisi√ß√£o</button>
            </div>
        </form>
    </div>
</div>

<!-- Informa√ß√µes da Requisi√ß√£o -->
<div class="info-section">
    <div class="info-card">
        <h4>Detalhes da Requisi√ß√£o</h4>
        <div class="info-grid">
            <div class="info-item">
                <strong>ID da Requisi√ß√£o:</strong>
                <span>#{{ requisicao.id }}</span>
            </div>
            <div class="info-item">
                <strong>Cliente:</strong>
                <span>{{ requisicao.cliente.nome }}</span>
            </div>
            <div class="info-item">
                <strong>Data de Cria√ß√£o:</strong>
                <span>{{ requisicao.data_criacao|date:"d/m/Y H:i" }}</span>
            </div>
            {% if requisicao.data_atualizacao %}
            <div class="info-item">
                <strong>√öltima Atualiza√ß√£o:</strong>
                <span>{{ requisicao.data_atualizacao|date:"d/m/Y H:i" }}</span>
            </div>
            {% endif %}
            <div class="info-item">
                <strong>Valor Total:</strong>
                <span class="valor-highlight">{{ requisicao.valor }} MT</span>
            </div>
            <div class="info-item">
                <strong>Forma de Pagamento:</strong>
                <span>
                    {% if requisicao.forma_pagamento == 'transferencia' %}
                    Transfer√™ncia Banc√°ria
                    {% if requisicao.banco %}
                    ({{ requisicao.banco }})
                    {% endif %}
                    {% elif requisicao.forma_pagamento == 'cash' %}
                    Dinheiro (Cash)
                    {% elif requisicao.forma_pagamento == 'pos' %}
                    POS (Cart√£o)
                    {% else %}
                    N√£o informado
                    {% endif %}
                </span>
            </div>
            <div class="info-item">
                <strong>Progress das Senhas:</strong>
                <span>
                    {{ requisicao.senhas_restantes }} / {{ requisicao.senhas }} restantes
                    {% if requisicao.senhas > 0 %}
                    ({{ percentual_utilizadas|floatformat:1 }}% utilizadas)
                    {% endif %}
                </span>
            </div>
        </div>
    </div>
</div>

<!-- Status da Requisi√ß√£o -->
<div class="info-section">
    <div class="info-card">
        <h4>Status da Requisi√ß√£o</h4>
        <div class="status-info">
            {% if requisicao.senhas_restantes == 0 %}
            <div class="status-badge status-completed">‚úÖ Requisi√ß√£o Conclu√≠da</div>
            <p>Todas as senhas foram utilizadas.</p>
            {% elif requisicao.senhas_restantes <= 5 %}
            <div class="status-badge status-warning">‚ö†Ô∏è Poucas Senhas Restantes</div>
            <p>Considere recarregar ou criar uma nova requisi√ß√£o.</p>
            {% elif requisicao.senhas_restantes <= 15 %}
            <div class="status-badge status-medium">üî∂ Senhas em Uso</div>
            <p>Requisi√ß√£o em andamento normal.</p>
            {% else %}
            <div class="status-badge status-high">üü¢ Muitas Senhas Dispon√≠veis</div>
            <p>Requisi√ß√£o rec√©m-criada ou com muitas senhas restantes.</p>
            {% endif %}
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const formaPagamentoSelect = document.getElementById('forma_pagamento');
        const bancoGroup = document.getElementById('banco-group');
        const bancoInput = document.getElementById('banco');

        function toggleBancoField() {
            if (formaPagamentoSelect.value === 'transferencia') {
                bancoGroup.style.display = 'block';
                bancoInput.required = true;
            } else {
                bancoGroup.style.display = 'none';
                bancoInput.required = false;
                bancoInput.value = '';
            }
        }

        // Executar no carregamento da p√°gina
        toggleBancoField();

        // Executar quando a forma de pagamento mudar
        formaPagamentoSelect.addEventListener('change', toggleBancoField);
    });
</script>

{% endblock %}